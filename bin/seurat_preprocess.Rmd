---
title: "scRNA Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: console
params:
  species: "hg19"
  sampleid: "WB_Lysis_1"
  h5: "~/../../Volumes/data/scRNA_test/cellranger_counts/sample1/outs/filtered_feature_bc_matrix.h5"
  Rlib_dir: "~/../../Volumes/CCBR_Pipeliner-1/db/PipeDB/Rlibrary_4.3_scRNA"
  Rpkg_config: "~/../../Volumes/CCBR_Pipeliner-1/Pipelines/TechDev_scRNASeq_Dev2023/conf/Rpack.config"
  scRNA_functions: "scRNA_functions.R"
  testing: "Y"
---

```{r, prep_args,  message=FALSE, echo=FALSE, include=FALSE}
# set up params
testing = params$testing
Rlib_dir=params$Rlib_dir
Rpkg_config=params$Rpkg_config
h5 = params$h5 
species= params$species
sampleid = params$sampleid
scRNA_functions = params$scRNA_functions
```

```{r, handle_pkg, message=FALSE, include=FALSE}
# set library dir, load this and remove any other dirs to avoid confusion
# between personally created pkgs and the pipeline package
## saving old path "/Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library"
print(paste0("Using the lib.loc location: ",Rlib_dir))
assign(".lib.loc", Rlib_dir, envir = environment(.libPaths))
.libPaths()

# load shared objects
#dyn.load('/gpfs/gsfs10/users/CCBR_Pipeliner/db/PipeDB/Rlibrary_4.3_scRNA/KernSmooth/libs/KernSmooth.so')

# read in package info
pkg_df=read.csv(Rpkg_config)
pkg_df=subset(pkg_df,preprocess=="Y")
pkg_df

# for each package check installation, if present then load library
for (rowid in rownames(pkg_df)){
  pkg=pkg_df[rowid,"package"]
  source=pkg_df[rowid,"source"]
  version=pkg_df[rowid,"version"]
  gh_name=pkg_df[rowid,"gh_name"]

  need_install <- pkg[!(pkg %in% installed.packages()[,"Package"])]
  if (length(need_install)!=0){
    print(paste0("Installing: ", pkg))
    if (source=="bc") BiocManager::install(pkg)
    if (source=="cr") install.packages(pkg,version=version,repos = "http://cran.us.r-project.org",
                                       local = FALSE)
    if (source=="gh") remotes::install_github(gh_name,version=version,local = FALSE)
  }

  print(paste0("Loading: ",pkg))
  invisible(lapply(pkg, library, character.only = TRUE))
}

# source functions
source(scRNA_functions)

# additional options
```

```{r, pre-processing, message=FALSE, include=FALSE, warning=FALSE}
# read in h5 file
rnaCounts = Read10X_h5(h5)

# create S object
if (testing=="T"){
  pbmc.data=Read10X(data.dir="~/../../Volumes/CCBR_Pipeliner/Pipelines/TechDev_scRNASeq_Dev2023/data_storage/10xFQ/filtered_gene_bc_matrices/hg19/")
  so = CreateSeuratObject(counts = pbmc.data, project = "pbmc3k", min.cells = 3, min.features = 200)
} else {
  so <- CreateSeuratObject(counts=rnaCounts)
}

# add metadata
so$Sample = sampleid

# determine percent mito
## http://htmlpreview.github.io/?https://github.com/satijalab/seurat-wrappers/blob/master/docs/miQC.html
so[["percent.mt"]] = PercentageFeatureSet(so, pattern = "^[M,m]T-")
FeatureScatter(so, feature1 = "nFeature_RNA", feature2 = "percent.mt")
```

```{r, QC, message=FALSE, include=FALSE, warning=FALSE}
# run QC, subset for features meeting critera
so_qc <- RunMiQC(so, 
              percent.mt = "percent.mt",
              nFeature_RNA = "nFeature_RNA", 
              posterior.cutoff = 0.7,
              model.slot = "flexmix_model")
print(so_qc)
PlotMiQC(so_qc, 
         color.by = "miQC.probability") + 
  ggplot2::scale_color_gradient(low = "grey", high = "purple")
VlnPlot(so_qc, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)

# subset
so_filt = subset(so_qc, miQC.keep == "keep")
so_filt
```

```{r, processing, message=FALSE, include=FALSE, warning=FALSE}
# Process data
so_processed = MAIN_PROCESS_SO(so_filt, species)

# Label data
so_labeled = MAIN_LABEL_SO(so_processed,species)

# ID doublets
dfso = PROCESS_DOUBLETS(so_labeled)

#label and filter
so_labeled$DF_hi.lo = dfso[[tail(names(dfso@meta.data),1)]]
so_singlet=subset(so_labeled,cells=names(so_labeled$DF_hi.lo)[so_labeled$DF_hi.lo =="Singlet"])

#save file
fpath=paste0(sampleid,"_seurat_object.rds")
saveRDS(so_singlet,fpath)
```