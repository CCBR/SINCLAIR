---
title: "Batch Correction: rpca"
author: "Samantha Sevilla"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
params:
  ref: "hg19"
  gid: "group1_group2"
  input_files: "~/../../Volumes/data-1/scRNA_test/seurat/group1_group2.rds"
  resolution_list: "0.1,0.2,0.3,0.5,0.6,0.8,1"
  shared_source: "CCBR_Pipeliner/db/PipeDB/Rlibrary_4.3_scRNA"
  pkg_info: "~/../../Volumes/CCBR_Pipeliner/Pipelines/TechDev_scRNASeq_Dev2023/conf/Rpack.config"
  testing: "Y"
---


```{r, prep_args,  message=FALSE, echo=FALSE, include=FALSE}
# set up params
ref= params$ref
gid = params$gid
mergedObj=params$mergedObj
resolution=as.numeric(strsplit(params$resolution_list,",")[[1]])

shared_source=params$shared_source
pkg_info=params$pkg_info
testing = params$testing

npcs = 50


args <- commandArgs(trailingOnly = TRUE)

matrix <- as.character(args[1])
outDirSeurat = as.character(args[2])
ref = as.character(args[3])
contrasts = as.character(args[4])



```

```{r, handle_pkg, message=FALSE, include=FALSE}
# set library dir, load this and remove any other dirs to avoid confusion
# between personally created pkgs and the pipeline package
if (testing=="Y"){
  # saving old path "/Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library"
  library_db_loc = paste0("~/../../Volumes/",shared_source)
}else {
  library_db_loc = paste0("/data/",shared_source)
}
assign(".lib.loc", library_db_loc, envir = environment(.libPaths))
.libPaths()

# read in package info
pkg_df=read.csv(pkg_info)
pkg_df=subset(pkg_df,bcs=="Y")
pkg_df

# for each package check installation, if present then load library
for (rowid in rownames(pkg_df)){
  pkg=pkg_df[rowid,"package"]
  source=pkg_df[rowid,"source"]
  version=pkg_df[rowid,"version"]
  gh_name=pkg_df[rowid,"gh_name"]
  print(pkg)

  need_install <- pkg[!(pkg %in% installed.packages()[,"Package"])]

  if (source=="bc" & length(need_install)!=0) BiocManager::install(pkg,version=version)
  if (source=="cr" & length(need_install)!=0) install.packages(pkg,version=version)
  if (source=="gh" & length(need_install)!=0) remotes::install_github(gh_name,version=version)

  invisible(lapply(pkg, library, character.only = TRUE))
}

# source functions
source("scRNA_functions.R")
options(future.globals.maxSize = 64000 * 1024^2)

```

library(htmltools,lib.loc=loc)
library(rlang,lib.loc=loc)
library(globals,lib.loc=loc)
library(stringr,lib.loc=loc)
library(Seurat,lib.loc=loc)
library("SingleR",lib.loc=loc)
library(scRNAseq,lib.loc=loc)
library(SingleCellExperiment,lib.loc=loc)
library(dplyr)
library(Matrix) 
library(tools)
library(glmGamPoi,lib.loc=loc)



```{r}
# delete all

file.names <- dir(path = matrix,pattern ="rds")

groupFile = read.delim("groups.tab",header=F,stringsAsFactors = F)
groupFile=groupFile[groupFile$V2 %in% stringr::str_split_fixed(contrasts,pattern = "-",n = Inf)[1,],]

splitFiles = gsub(".rds","",file.names)#str_split_fixed(file.names,pattern = "[.rd]",n = 2) 
splitFiles = stringr::str_split_fixed(splitFiles,pattern = "__",n = Inf)[,1]
file.names=file.names[match(groupFile$V1,splitFiles,nomatch = F)]
print(groupFile$V1)
print(splitFiles)
print(file.names)    

readObj = list()
for (obj in file.names) {
  Name=strsplit(obj,".rds")[[1]][1]
  assign(paste0("S_",Name),readRDS(paste0(matrix,"/",obj)))
  readObj = append(readObj,paste0("S_",Name))  
 }



combinedObj.list=list()
i=1
for (p in readObj){
  combinedObj.list[[p]] <- eval(parse(text = readObj[[i]])) 
  combinedObj.list[[p]]$Sample = names(combinedObj.list)[i]
  i <- i + 1
 }

reference.list <- combinedObj.list[unlist(readObj)]

```

```{r}

# keep import merged obj
reference.list <- lapply(X = mergedObj, 
                         FUN = SCTransform, method = "glmGamPoi",
                         variable.features.rv.th = 1.3,variable.features.n = NULL)
selectFeatures <- SelectIntegrationFeatures(object.list = reference.list, nfeatures = 3000)
reference.list <- PrepSCTIntegration(object.list = reference.list, 
                                     anchor.features = selectFeatures, verbose = FALSE)
reference.list <- lapply(X = reference.list, FUN = RunPCA, features = selectFeatures)


# set anchor
combinedObj.anchors <- FindIntegrationAnchors(object.list = reference.list, 
                                              normalization.method = "SCT",
                                              anchor.features = selectFeatures, 
                                              dims = 1:30, reduction = "rpca", 
                                              k.anchor = 20)


combinedObj.integrated <- IntegrateData(anchorset = combinedObj.anchors, 
                                        normalization.method = "SCT", 
                                        dims = 1:30)

# TBD - relabel samples with "__"?
combinedObj.integrated$Sample = stringr::str_split_fixed(combinedObj.integrated$Sample,
                                                         pattern = "__",n = Inf)[,1]

# Keep add group info
combinedObj.integrated$groups = groupFile$V2[match(combinedObj.integrated$Sample,
                                                   paste0("S_",groupFile$V1),nomatch = F)]

# keep - run RPCA
combinedObj.integrated = RUN_CORRECTION_RPCA(combinedObj.integrated,npcs)

# keep - save output
fpath=paste0(gid,"_batchcorrection_rpca.rds")
saveRDS(combinedObj.integrated,fpath)
```