---
title: "Batch Correction: Seurat Integration"
author: "Samantha Sevilla"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
params:
  species: "hg19"
  gid: "group1-group2"
  mergedObj: "~/../../Volumes/data/scRNA_test/seurat/merge/group1-group2_seurat_merged.rds"
  resolution_list: "0.1,0.2,0.3,0.5,0.6,0.8,1"
  Rlib_dir: "~/../../Volumes/CCBR_Pipeliner/db/PipeDB/Rlibrary_4.3_scRNA"
  Rpkg_config: "~/../../Volumes/CCBR_Pipeliner/Pipelines/TechDev_scRNASeq_Dev2023/conf/Rpack.config"
  scRNA_functions: "scRNA_functions.R"
  testing: "Y"
---


```{r, prep_args,  message=FALSE}
# set up params
species= params$species
gid = params$gid
mergedObj=params$mergedObj
resolution=as.numeric(strsplit(params$resolution_list,",")[[1]])

Rlib_dir=params$Rlib_dir
Rpkg_config=params$Rpkg_config
testing = params$testing
scRNA_functions=params$scRNA_functions

# other variables
npcs = 50
```

```{r, handle_pkg, message=FALSE}
# set library dir, load this and remove any other dirs to avoid confusion
# between personally created pkgs and the pipeline package
## saving old path "/Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library"
print(paste0("Using the lib.loc location: ",Rlib_dir))
assign(".lib.loc", Rlib_dir, envir = environment(.libPaths))
.libPaths()

# read in package info
pkg_df=read.csv(Rpkg_config)
pkg_df=subset(pkg_df,bcs=="Y")
pkg_df

# for each package check installation, if present then load library
for (rowid in rownames(pkg_df)){
  pkg=pkg_df[rowid,"package"]
  source=pkg_df[rowid,"source"]
  version=pkg_df[rowid,"version"]
  gh_name=pkg_df[rowid,"gh_name"]

  need_install <- pkg[!(pkg %in% installed.packages()[,"Package"])]
  if (length(need_install)!=0){
    print(paste0("Installing: ", pkg))
    if (source=="bc") BiocManager::install(pkg)
    if (source=="cr") install.packages(pkg,version=version,repos = "http://cran.us.r-project.org",
                                        local = FALSE)
    if (source=="gh") remotes::install_github(gh_name,version=version,local = FALSE)
  }

  print(paste0("Loading: ",pkg))
  invisible(lapply(pkg, library, character.only = TRUE))
}

# source functions
source(scRNA_functions)

# additional options
tinytex::install_tinytex(force = TRUE)
options(future.globals.maxSize = 96000 * 1024^2)
```

```{r}
# keep - this will be the input object
reference.list <- readRDS(mergedObj)

# unclear why we are doing this again? 
# done in seurat_preprocess, line 99
# done again in seurat_preprocess, line 105
reference.list <- lapply(X=reference.list, FUN=SCTransform)

# keep - this will set features
selectFeatures <- SelectIntegrationFeatures(object.list = reference.list, nfeatures = 3000)

# keep - need new variable name
reference.list <- PrepSCTIntegration(object.list = reference.list, 
                                     anchor.features = selectFeatures, verbose = FALSE)

# if there is more than 100K features
# for each group determine if there are more than two samples,
if(sum(sapply(combinedObj.list,ncol))>100000){
  refIndex = vector()
  for(group in unique(groupFile$V2)){
    if(length(grep(group,groupFile$V2))>2){
      # if so then refIndex adds ?? unclear what this is doing
      refIndex = c(refIndex,sample(grep(group,groupFile$V2),1))
    }
  }
  # if so then refIndex adds ?? unclear what this is doing
  if(length(refIndex)==0){refIndex = sample(length(reference.list),1)}
  print(refIndex)
  
  # keep - creates .anchors with refIndex
  combinedObj.anchors <- FindIntegrationAnchors(object.list = reference.list, dims = 1:30, anchor.features = 3000,reference=refIndex)
} else{
  
  # keep - if there is not 100K, then does not use refIndex
  combinedObj.anchors <- FindIntegrationAnchors(object.list = reference.list, dims = 1:30, anchor.features = 3000)
}
```

```{r}
# keep - create new obj
combinedObj.integrated <- IntegrateData(anchorset = combinedObj.anchors, dims = 1:30)

# TBD - relabel samples with "__"?
combinedObj.integrated$Sample = stringr::str_split_fixed(combinedObj.integrated$Sample,
                                                         pattern = "__",n = Inf)[,1]

# keep - add groups label
combinedObj.integrated$groups = groupFile$V2[match(combinedObj.integrated$Sample, 
                                                   paste0("S_",groupFile$V1),nomatch = F)]

# keep - create new obj, change variable name
DefaultAssay(object = combinedObj.integrated) <- "integrated"
```

```{r saveoutputs, message=FALSE, include=FALSE, echo=FALSE}
# delete - contrasts=NONE
fpath=paste0(gid,"_intermediate_integrated.rds")
saveRDS(combinedObj.integrated,fpath)

# intermed - do we need this?
fpath=paste0(gid,"_int.rds")
saveRDS(combinedObj.integrated,fpath)

# keep run integration - reorder and move to separate block for processing
combinedObj.integrated = RUN_CORRECTION_SEURAT(combinedObj.integrated,npcs,
                                 ref,resolution)

# keep - output object
fpath=paste0(gid,"_batchcorrection_seurat.rds")
saveRDS(combinedObj.integrated,fpath)
```