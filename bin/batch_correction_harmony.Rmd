---
title: "Batch Correction: Harmony"
author: "Samantha Sevilla"
date: "`r Sys.Date()`"
output: html_document
editor_options:
  chunk_output_type: console
params:
  gid: "group1_group2"
  mergedObj: "results/seurat/merge/group1-group2_seurat_merged.rds"
  species: "hg19"
  resolution_list: "0.1,0.2,0.3,0.5,0.6,0.8,1"
  npcs: "50"
  vars_to_regress: "percent.mt,nFeature_RNA"
  scRNA_functions: "bin/scRNA_functions.R"
  testing: "Y"
---

```{r setup,  message=FALSE, echo=FALSE, include=FALSE}
options(future.globals.maxSize = 96000 * 1024^2)
# set up params
species <- params$species
gid <- params$gid
mergedObj <- params$mergedObj
resolution <- as.numeric(strsplit(params$resolution_list, ",")[[1]])
npcs <- as.numeric(params$npcs)
vars_to_regress_list <- strsplit(gsub(" ", "", params$vars_to_regress), ",")[[1]]

source(params$scRNA_functions)
library(Seurat)
library(SeuratWrappers)
library(SingleR)
library(tinytex)
library(AnnotationDbi)
library(org.Hs.eg.db)
library(org.Mm.eg.db)
library(Orthology.eg.db)
library(harmony)
```

```{r, processing, message=FALSE}
# read in merged object
so <- readRDS(mergedObj)

# assign assay
DefaultAssay(so) <- "RNA"
so[["RNA"]] <- as(so[["RNA"]], Class = "Assay5")
so[["RNA"]] <- split(so[["RNA"]], f = so$Sample)

# integrate
so_corrected <- MAIN_BATCH_CORRECTION(so, npcs, species, resolution,
  method_in = "HarmonyIntegration", reduction_in = "harmony",
  v_list = vars_to_regress_list
)
```

```{r saveoutputs, message=FALSE, include=FALSE, echo=FALSE}
fpath <- paste0(gid, "_batch_correction_harmony.rds")
saveRDS(so_corrected, fpath)
```
