---
title: "Seurat_Integration"
author: "Samantha Sevilla"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
params:
  ref: "hg19"
  contrast_list: "WB_Lysis_1-WB_Lysis_2"
  resolution_list: "0.1,0.2,0.3,0.5,0.6,0.8,1"
  input_files: "~/../../Volumes/data-1/scRNA_test/Seurat/WB_Lysis_1_seurat_object.rds ~/../../Volumes/data-1/scRNA_test/Seurat/WB_Lysis_2_seurat_object.rds"
  shared_source: "CCBR_Pipeliner/db/PipeDB/Rlibrary_4.2.2_scRNA"
  pkg_info: "~/../../Volumes/CCBR_Pipeliner/Pipelines/TechDev_scRNASeq_Dev2023/conf/Rpack.config"
---

```{r, prep_args,  message=FALSE, echo=FALSE, include=FALSE}
# set up params
ref= params$ref
contrast_list = params$contrast_list
resolution=as.numeric(strsplit(params$resolution_list,",")[[1]])
input_files=params$input_files

shared_source=params$shared_source
pkg_info=params$pkg_info

options(future.globals.maxSize = 96000 * 1024^2)
npcs = 50
```

```{r, handle_pkg, message=FALSE, echo=FALSE, include=FALSE}
# set library dir, load this and remove any other dirs to avoid confusion
# between personally created pkgs and the pipeline package
testing="Y"
if (testing=="Y"){
  # saving old path "/Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library"
  library_db_loc = paste0("~/../../Volumes/",shared_source)
}else {
  library_db_loc = paste0("/data/",shared_source)
}
assign(".lib.loc", library_db_loc, envir = environment(.libPaths))
.libPaths()

# read in package info
pkg_df=read.csv(pkg_info)
pkg_df=subset(pkg_df,integration=="Y")


# library(htmltools,lib.loc=loc)
# library(Seurat,lib.loc=loc)
# library("SingleR",lib.loc=loc)
# library(scRNAseq,lib.loc=loc)
# library(SingleCellExperiment,lib.loc=loc)
# library(dplyr)
# library(Matrix)
# library(tools)
# library(stringr)

# for each package check installation, if present then load library
for (rowid in rownames(pkg_df)){
  pkg=pkg_df[rowid,"pkg"]
  source=pkg_df[rowid,"source"]
  version=pkg_df[rowid,"version"]
  gh_name=pkg_df[rowid,"gh_name"]
  
  need_install <- pkg[!(pkg %in% installed.packages()[,"Package"])]

  if (source=="bc" & !is.null(need_install)) BiocManager::install(pkg,version=version)
  if (source=="cr" & !is.null(need_install)) install.packages(pkg,version=version)
  if (source=="gh" & !is.null(need_install)) remotes::install_github(gh_name,version=version)

  invisible(lapply(pkg, library, character.only = TRUE))
}

# print pkg info
DT::datatable(pkg_df)

# source functions
source("scRNA_functions.R")
```

```{r}
contrast1=strsplit(contrast_list,"-")[[1]][1]
contrast2=strsplit(contrast_list,"-")[[1]][2]

file.names=strsplit(input_files," ")[[1]]
```

```{r}
readObj = list()
for (obj in file.names) {
  contrast_id=gsub("^.*/", "", gsub("_seurat_object.rds","",obj))
  assign(paste0("S_",contrast_id),readRDS(obj))
  readObj = append(readObj,paste0("S_",contrast_id))
}

combinedObj.list=list()
i=1
for (p in readObj){
  combinedObj.list[[p]] <- eval(parse(text = readObj[[i]]))
  combinedObj.list[[p]]$Sample = names(combinedObj.list)[i]
  i <- i + 1
 }

```

```{r}
reference.list <- combinedObj.list[unlist(readObj)]
reference.list <- lapply(X=reference.list, FUN=SCTransform)
selectFeatures <- SelectIntegrationFeatures(object.list = reference.list, nfeatures = 3000)
reference.list <- PrepSCTIntegration(object.list = reference.list, 
                                     anchor.features = selectFeatures, verbose = FALSE)
if(sum(sapply(combinedObj.list,ncol))>100000){
  refIndex = vector()
  for(group in unique(groupFile$V2)){
    if(length(grep(group,groupFile$V2))>2){
      refIndex = c(refIndex,sample(grep(group,groupFile$V2),1))
    }
  }
  if(length(refIndex)==0){refIndex = sample(length(reference.list),1)}
  print(refIndex)
  combinedObj.anchors <- FindIntegrationAnchors(object.list = reference.list, dims = 1:30,anchor.features = 3000,reference=refIndex)
}else{
  combinedObj.anchors <- FindIntegrationAnchors(object.list = reference.list, dims = 1:30,anchor.features = 3000)
}
```

```{r}
combinedObj.integrated <- IntegrateData(anchorset = combinedObj.anchors, dims = 1:30)
combinedObj.integrated$Sample = stringr::str_split_fixed(combinedObj.integrated$Sample,pattern = "__",n = Inf)[,1]
combinedObj.integrated$groups = groupFile$V2[match(combinedObj.integrated$Sample, 
                                                   paste0("S_",groupFile$V1),nomatch = F)]
DefaultAssay(object = combinedObj.integrated) <- "integrated"

```

```{r}
# contrasts=NONE
fpath=paste0(contrast_list,"_intermediate_integrated.rds")
saveRDS(combinedObj.integrated,fpath)

# intermed
fpath=paste0(contrast_list,"_int.rds")
saveRDS(combinedObj.integrated,"int.rds")

# final
fpath=paste0(contrast_list,"_seuratIntegrated.rds")
combinedObj.integrated = runInt(combinedObj.integrated,npcs)
saveRDS(combinedObj.integrated,fpath)

```


