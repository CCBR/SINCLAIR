<!DOCTYPE html><html class=writer-html5 lang=en> <head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width, initial-scale=1.0"><meta name=author content="CCR Collaborative Bioinformatics Resource"><link rel="shortcut icon" href=../../img/favicon.ico><title>1. Differential Expression Analysis - SINCLAIR</title><link rel=stylesheet href=../../css/theme.css><link rel=stylesheet href=../../css/theme_extra.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css><link href=../../css/custom.css rel=stylesheet><link href=../../css/version-select.css rel=stylesheet><script>
        // Current page data
        var mkdocs_page_name = "1. Differential Expression Analysis";
        var mkdocs_page_input_path = "user-guide/differentialExpression.md";
        var mkdocs_page_url = null;
      </script><!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]--><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js></script><script>hljs.highlightAll();</script></head> <body class=wy-body-for-nav role=document> <div class=wy-grid-for-nav> <nav data-toggle=wy-nav-shift class="wy-nav-side stickynav"> <div class=wy-side-scroll> <div class=wy-side-nav-search> <a href=../.. class="icon icon-home"> SINCLAIR </a><div role=search> <form id=rtd-search-form class=wy-form action=../../search.html method=get> <input type=text name=q placeholder="Search docs" aria-label="Search docs" title="Type search term here"> </form> </div> </div> <div class="wy-menu wy-menu-vertical" data-spy=affix role=navigation aria-label="Navigation menu"> <ul> <li class=toctree-l1><a class="reference internal" href=../..>Background</a> </li> </ul> <p class=caption><span class=caption-text>Usage</span></p> <ul> <li class=toctree-l1><a href=../getting-started/ class="reference internal">1. Getting Started</a> </li> <li class=toctree-l1><a href=../preparing-files/ class="reference internal">2. Preparing Files</a> </li> <li class=toctree-l1><a href=../run/ class="reference internal">3. Running the Pipeline</a> </li> <li class=toctree-l1><a href=../output/ class="reference internal">4. Expected Output</a> </li> <li class=toctree-l1><a href=../test-info/ class="reference internal">5. Running Test Data</a> </li> </ul> <p class=caption><span class=caption-text>Analysis</span></p> <ul class=current> <li class="toctree-l1 current"><a class="reference internal current" href=#>1. Differential Expression Analysis</a> <ul class=current> <li class=toctree-l2><a class="reference internal" href=#choosing-the-identities>Choosing the identities</a> </li> <li class=toctree-l2><a class="reference internal" href=#preparing-the-seurat-object-for-differential-expression-with-prepsctfindmarkers>Preparing the Seurat object for differential expression with PrepSCTFindMarkers</a> </li> <li class=toctree-l2><a class="reference internal" href=#finding-differentially-expressed-genes-in-seurat>Finding differentially expressed genes in Seurat</a> <ul> <li class=toctree-l3><a class="reference internal" href=#option-1-running-findmarkersref>Option 1: Running FindMarkersref</a> </li> <li class=toctree-l3><a class="reference internal" href=#option-2-running-findallmarkersref>Option 2: Running FindAllMarkersref</a> </li> <li class=toctree-l3><a class="reference internal" href=#alternative-methods-for-differential-expression>Alternative methods for differential expression</a> </li> </ul> </li> <li class=toctree-l2><a class="reference internal" href=#expected-outputs>Expected outputs</a> </li> <li class=toctree-l2><a class="reference internal" href=#common-issues-and-questions>Common issues and questions</a> <ul> <li class=toctree-l3><a class="reference internal" href=#why-are-there-so-many-genes-with-extremely-small-p-values>Why are there so many genes with extremely small p-values?</a> </li> <li class=toctree-l3><a class="reference internal" href=#requiring-joinlayers>Requiring JoinLayers</a> </li> <li class=toctree-l3><a class="reference internal" href=#running-differential-expression-on-subsets-of-cells>Running differential expression on subsets of cells</a> </li> <li class=toctree-l3><a class="reference internal" href=#pseudobulk-differential-expression>Pseudobulk differential expression</a> </li> </ul> </li> </ul> </li> </ul> <p class=caption><span class=caption-text>FAQ</span></p> <ul> <li class=toctree-l1><a href=../troubleshooting/ class="reference internal">Troubleshooting</a> </li> <li class=toctree-l1><a href=../../contributing/ class="reference internal">How to contribute</a> </li> <li class=toctree-l1><a href=../contributions/ class="reference internal">Contributors</a> </li> </ul> </div> </div> </nav> <section data-toggle=wy-nav-shift class=wy-nav-content-wrap> <nav class=wy-nav-top role=navigation aria-label="Mobile navigation menu"> <i data-toggle=wy-nav-top class="fa fa-bars"></i> <a href=../..>SINCLAIR</a> </nav> <div class=wy-nav-content> <div class=rst-content><div role=navigation aria-label="breadcrumbs navigation"> <ul class=wy-breadcrumbs> <li><a href=../.. class="icon icon-home" aria-label=Docs></a></li> <li class=breadcrumb-item>Analysis</li> <li class="breadcrumb-item active">1. Differential Expression Analysis</li> <li class=wy-breadcrumbs-aside> <a href=https://github.com/CCBR/SINCLAIR/edit/feature/gex_only/docs/user-guide/differentialExpression.md>Edit on CCBR/SINCLAIR</a> </li> </ul> <hr> </div> <div role=main class=document itemscope=itemscope itemtype=http://schema.org/Article> <div class=section itemprop=articleBody> <h1 id=running-differential-expression>Running Differential Expression<a class=headerlink href=#running-differential-expression title="Permanent link">&para;</a></h1> <p><em>Adapted from the <a href=https://satijalab.org/seurat/articles/de_vignette>Seurat differential expression vignette</a></em></p> <p>When running differential expression on the Seurat object produced by SINCLAIR, these steps should be followed to ensure an accurate output</p> <h2 id=choosing-the-identities>Choosing the identities<a class=headerlink href=#choosing-the-identities title="Permanent link">&para;</a></h2> <p>Before running any sort of differential expression, the identities of the Seurat object need to be determined and set by the user. For example, the following code will set the Seurat object identities to the clusters found at resolution 0.8:</p> <div class=highlight><pre><span></span><code>Idents(seuratObject) = &quot;SCT_snn_res.0.8&quot;
</code></pre></div> <p>The identities are not limited to the clusters; these can be set to any categorical variable in the metadata, including cell types that have been determined by SingleR or classified by the user, cell cycle phase (G1/G2M/S), or experimental group.</p> <h2 id=preparing-the-seurat-object-for-differential-expression-with-prepsctfindmarkers>Preparing the Seurat object for differential expression with <code>PrepSCTFindMarkers</code><a class=headerlink href=#preparing-the-seurat-object-for-differential-expression-with-prepsctfindmarkers title="Permanent link">&para;</a></h2> <p>After defining the object identities, Seurat requires that when when running differential expression on the SCT assay, the object needs to be prepared with the <code>PrepSCTFindMarkers</code> function:</p> <div class=highlight><pre><span></span><code>seuratObject = PrepSCTFindMarkers(seuratObject)
</code></pre></div> <p>The purpose of the <code>PrepSCTFindMarkers</code> is to use the minimum of the median UMI of individual objects to appropriately scale the SCT assay prior to differential expression<sup><a href=#refPrepSCTfindMarkers>ref</a></sup>.</p> <h2 id=finding-differentially-expressed-genes-in-seurat>Finding differentially expressed genes in Seurat<a class=headerlink href=#finding-differentially-expressed-genes-in-seurat title="Permanent link">&para;</a></h2> <p>Two options are available when running differential expression through Seurat.</p> <h3 id=option-1-running-findmarkersref>Option 1: Running <code>FindMarkers</code><sup><a href=#refFindMarkers>ref</a></sup><a class=headerlink href=#option-1-running-findmarkersref title="Permanent link">&para;</a></h3> <p>The "traditional" method of running differential expression compares two separate categories; this can still be exercised in the presence of more than the two comparison groups of interest. Following the example above, comparing the two largest clusters as determined by Seurat would be run as follows:</p> <div class=highlight><pre><span></span><code>deGeneList = FindMarkers(seuratObject,ident.1=0,ident.2=1,test.use = &quot;MAST&quot;)
</code></pre></div> <p>By default, Seurat uses the non-parametric Wilcoxon rank-sum test to identify significant genes. The MAST<sup><a href=#refMAST>ref</a></sup> algorithm uses a hurdle model to account for the sparsity of scRNASeq count matrices, and tends to be more sensitive to likely changes.</p> <h3 id=option-2-running-findallmarkersref>Option 2: Running <code>FindAllMarkers</code><sup><a href=#refFindAllMarkers>ref</a></sup><a class=headerlink href=#option-2-running-findallmarkersref title="Permanent link">&para;</a></h3> <p>When looking to define a set of potential clusters or identities using gene markers, the <code>FindAllMarkers</code> function will run the differential expression by setting the first identity group (equivalent to <code>ident.1</code>) to each cluster in turn and using the remaining clusters as the comparison group (<code>ident.2</code>).</p> <div class=highlight><pre><span></span><code>markerGeneList = FindAllMarkers(seuratObject,test.use=&quot;MAST&quot;)
</code></pre></div> <p>The resulting list will show the differentially expressed genes that are significantly enriched or depleted for each identity within the preselected category. In essence, <code>FindAllMarkers</code> runs a loop where <code>FindMarkers</code> is run for each individual identity.</p> <h3 id=alternative-methods-for-differential-expression>Alternative methods for differential expression<a class=headerlink href=#alternative-methods-for-differential-expression title="Permanent link">&para;</a></h3> <p>The default values for some of the more frequently altered parameters for the <code>FindMarkers</code> and <code>FindAllMarkers</code> functions are as follows:</p> <div class=highlight><pre><span></span><code>deGenes = FindMarkers(seuratObject, ident.1=NA, ident.2=NA, features=NULL,
  test.use=&quot;wilcox,&quot; logfc.threshold=0.25, min.pct=0.1)
</code></pre></div> <p>If <code>ident.1</code> is defined and <code>ident.2</code> is left as a NULL value, the cells not included in <code>ident.1</code> will be used as the comparison, i.e. essentially running a one vs. rest comparison, similar to what is described in <code>FindAllMarkers</code>.</p> <p>The <code>features</code> parameter can take a vector of specified genes and only run differential expression for those genes. Note that this assumes that the gene is not filtered out by any other criteria, such as those listed below. In all other cases, all genes are run through initial filtering and statistical testing.</p> <p>The <code>test.use</code> parameter is used to change the statistical test applied to identify differentially expressed genes. As mentioned above, the MAST algorithm is often applied to single cell data, while other tests that can be applied include <code>"bimod"</code>, <code>"roc"</code>, <code>"t"</code>, <code>"negbinom"</code>, <code>"poisson"</code>, <code>"LR"</code>, and <code>"DESeq2"</code>.</p> <p>The <code>logfc.threshold</code> filters out all genes that do not meet a log2 fold change threshold. This is applied to improve the speed of the computation, as those genes that do not meet this value are not subjected to statistical testing. The default threshold value is 0.25, which is roughly a 20% average fold change.</p> <p>The <code>min.pct</code> threshold filters out genes that are not expressed in the fraction of cells below the threshold for <strong>both</strong> comparison groups. If only one comparison group is below the threshold, the statistics for the gene will still be calculated. The default <code>min.pct</code> threshold is 0.1, or 10%.</p> <p>Since a number of genes will be unaffected by the experiment, a full differential expression list will require setting both <code>logfc.threshold</code> and <code>min.pct</code> to 0, so as to calculate the statistics for less relevant genes. These parameters may also need to be adjusted when selecting specific genes with the <code>features</code> parameter, as any user-defined genes that do not meet the threshold criteria will not be submitted to statistical testing.</p> <h2 id=expected-outputs>Expected outputs<a class=headerlink href=#expected-outputs title="Permanent link">&para;</a></h2> <p>The output of the <code>deGeneList</code> variable above will have a table structure resembling the following:</p> <table> <thead> <tr> <th></th> <th>p_val</th> <th>avg_log2FC</th> <th>pct.1</th> <th>pct.2</th> <th>p_val_adj</th> </tr> </thead> <tbody> <tr> <td>Tff1</td> <td>2.27649774378448e-20</td> <td>0.503646816090369</td> <td>0.313</td> <td>0.039</td> <td>5.15945448651315e-16</td> </tr> <tr> <td>Gkn1</td> <td>2.37538488060338e-18</td> <td>0.31537227402121</td> <td>0.23</td> <td>0.007</td> <td>5.3835722933995e-14</td> </tr> <tr> <td>Gkn2</td> <td>9.91735374467266e-14</td> <td>0.238583210040284</td> <td>0.166</td> <td>0.004</td> <td>2.24766905269261e-09</td> </tr> <tr> <td>Oaz1</td> <td>1.26240861948424e-12</td> <td>0.198987799763473</td> <td>0.996</td> <td>0.968</td> <td>2.86112289519909e-08</td> </tr> <tr> <td>Rab5c</td> <td>3.39748073842636e-12</td> <td>0.301705843310934</td> <td>0.645</td> <td>0.4</td> <td>7.7000503455695e-08</td> </tr> <tr> <td>Rbm3</td> <td>5.53653902770416e-12</td> <td>0.226144933696604</td> <td>0.97</td> <td>0.893</td> <td>1.25480120523887e-07</td> </tr> <tr> <td>Cfl1</td> <td>9.22315807122862e-12</td> <td>0.171800659275371</td> <td>1</td> <td>0.982</td> <td>2.09033654526325e-07</td> </tr> <tr> <td>Cd83</td> <td>2.27101797312635e-10</td> <td>0.242223105538207</td> <td>0.849</td> <td>0.789</td> <td>5.14703513429356e-06</td> </tr> <tr> <td>Tff2</td> <td>2.66531282660886e-10</td> <td>0.226607061165825</td> <td>0.189</td> <td>0.025</td> <td>6.04066499022633e-06</td> </tr> </tbody> </table> <p>The first unlabeled column lists the genes, followed by raw p-value, average log2 fold change, the percentage of cells expressing the gene in populations 1 and 2, and finally the adjusted p-value. The sign of the fold change and the definitions of <code>pct.1</code> and <code>pct.2</code> are defined by the order of groups selected in the <code>FindMarkers</code> call: Positive fold changes indicate enrichment in the first group (i.e. defined as <code>ident.1</code>), as well as the <code>pct.1</code> value</p> <h2 id=common-issues-and-questions>Common issues and questions<a class=headerlink href=#common-issues-and-questions title="Permanent link">&para;</a></h2> <h4 id=why-are-there-so-many-genes-with-extremely-small-p-values>Why are there so many genes with extremely small p-values?<a class=headerlink href=#why-are-there-so-many-genes-with-extremely-small-p-values title="Permanent link">&para;</a></h4> <p>In most circumstances, a small p-value generally indicates that the gene is extremely significant and should not be ignored. However, many of the statistical tests that are designed based on distributions, including MAST, operate under a set of assumptions. With single cell, one of the assumptions that gets violated is an upper limit on the number of replicates included, since each individual cell is treated as a replicate and leads to a comparison of 2 groups with as many as tens of thousands of replicates each.</p> <p>Unfortunately, it falls to the user to determine the relative significance of the genes that are identified as significant by examining the other statistics provided (i.e. <code>avg_log2FC</code> and <code>pct.1</code>/<code>pct.2</code>). Additionally, genes of interest can also be run through the <code>AverageExpression</code> and the <code>FeaturePlot</code> functions to explore the overall expression of the gene in the individual contrast groups. Other approaches, such as pseudobulk differential expression (see below) might be implemented in order to address this p-value phenomenon</p> <h4 id=requiring-joinlayers>Requiring <code>JoinLayers</code><a class=headerlink href=#requiring-joinlayers title="Permanent link">&para;</a></h4> <p>Since version 5, Seurat keeps individual samples as "layers" in the S4 data structure. This makes it simpler to apply various functions to each sample, such as SCTransform normalization or variable feature identification, since a single call to the Seurat object will behave like the <code>lapply</code> function in R. However, this also keeps the individual counts tables separate, which makes differential expression nigh impossible. To address this, the user needs to join the layers prior to running differential expression:</p> <div class=highlight><pre><span></span><code>so_dePrep = JoinLayers(seuratObject)
so_dePrep = PrepSCTFindMarkers(so_dePrep)
markers = FindAllMarkers(so_dePrep,test.use=&quot;MAST&quot;)
</code></pre></div> <h4 id=running-differential-expression-on-subsets-of-cells>Running differential expression on subsets of cells<a class=headerlink href=#running-differential-expression-on-subsets-of-cells title="Permanent link">&para;</a></h4> <p>Oftentimes the user will be interested in examining two different subsets of cells; for example, comparing the two experimental contrast groups in B cells alone. When isolating a group with the subset in question, the user might send a command such as:</p> <div class=highlight><pre><span></span><code>Bcells = subset(seuratObject,cells=colnames(seuratObject)[which(so$cellType==&quot;B cells&quot;)])
</code></pre></div> <p>However, when running <code>FindMarkers</code> on this subset, the following may be encountered:</p> <div class=highlight><pre><span></span><code>FindMarkers(Bcells,ident.1=&quot;group1&quot;,test.use=&quot;MAST&quot;)

Error in FindMarkers.SCTAssay(object = data.use, slot = slot, cells.1 = cells$cells.1,  :
  Object contains multiple models with unequal library sizes. Run `PrepSCTFindMarkers()` before running `FindMarkers()`.
</code></pre></div> <p>In this event, the user should ensure that the subset was extracted from the Seurat object that has already been prepared through <code>PrepSCTFindMarkers</code> to ensure appropriate scaling. The second step is to use a hidden parameter <code>recorrect_umi</code> to tell the program to "ignore" the scaling step.</p> <div class=highlight><pre><span></span><code>FindMarkers(Bcells,ident.1=&quot;group1&quot;,test.use=&quot;MAST&quot;, recorrect_umi=FALSE)
</code></pre></div> <p>In theory, this flag can also be used in all other steps in order to skip the scaling step for differential expression, but this is generally not recommended.</p> <h4 id=pseudobulk-differential-expression>Pseudobulk differential expression<a class=headerlink href=#pseudobulk-differential-expression title="Permanent link">&para;</a></h4> <p>If there are enough individual replicates, a user can convert the single cell dataset into a pseudobulk dataset and treat the individual samples as pooled replicates to be submitted through a standard RNASeq differential expression protocol, such as Limma or DESeq2. This has been explored using the <a href=https://github.com/neurorestore/Libra>Libra</a> tool and through <a href=https://satijalab.org/seurat/articles/de_vignette#perform-de-analysis-after-pseudobulking>Seurat</a> using their <code>AggregateExpression</code> function. The results tend to increase the p-values, which subsequently reduces the likelihood of false positives in identifying differentially expressed genes.</p> <p>The main warning when running a pseudobulk approach is to ensure that there are enough samples to warrant aggregation; if only one sample is available per experimental condition, the user will be attempting a 1v1 differential expression design, which is not nearly robust enough to account for any intra-group sample variability.</p> <p> </p> <p><font size=2>References:</p> <p><a name=refPrepSCTfindMarkers>1.</a> <a href=https://satijalab.org/seurat/reference/prepsctfindmarkers>PrepSCTFindMarkers</a></p> <p><a name=refFindMarkers>2.</a> <a href=https://satijalab.org/seurat/reference/findmarkers>FindMarkers</a></p> <p><a name=refFindAllMarkers>3.</a> <a href=https://satijalab.org/seurat/reference/findallmarkers>FindAllMarkers</a></p> <p></font></p> <p><font size=2>Author: Nathan Wong. January 2023</font></p> </div> </div><script async src="https://www.googletagmanager.com/gtag/js?id=G-D3SL9V30KL"></script> <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-D3SL9V30KL'); // Replace with your tracking ID
</script> </div> </div> </section> </div> <div class=rst-versions role=note aria-label=Versions> <span class=rst-current-version data-toggle=rst-current-version> <span> <a href=https://github.com/CCBR/SINCLAIR class="fa fa-code-fork" style="color: #fcfcfc"> CCBR/SINCLAIR</a> </span> <span><a href=../test-info/ style="color: #fcfcfc">&laquo; Previous</a></span> <span><a href=../troubleshooting/ style="color: #fcfcfc">Next &raquo;</a></span> </span> </div> <script src=../../js/jquery-3.6.0.min.js></script> <script>var base_url = "../..";</script> <script src=../../js/theme_extra.js></script> <script src=../../js/theme.js></script> <script src=../../js/custom.js></script> <script src=../../search/main.js></script> <script src=../../js/version-select.js></script> <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script> </body> </html> 